{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Quality report artifact",
  "description": "Output of quality phases: static checks, tests, denoise, frontend/backend quality, docs freshness, and security review with remediation tracking.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "audit_type",
    "violations",
    "summary"
  ],
  "allOf": [
    {
      "if": {
        "properties": {
          "audit_type": { "const": "security" }
        },
        "required": ["audit_type"]
      },
      "then": {
        "required": ["security_audit"],
        "properties": {
          "violations": {
            "items": {
              "required": ["category"]
            }
          }
        }
      }
    }
  ],
  "properties": {
    "audit_type": {
      "type": "string",
      "enum": ["static", "tests", "denoise", "frontend", "backend", "docs", "security"]
    },
    "violations": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["rule", "severity", "file", "evidence", "remediation", "status"],
        "allOf": [
          {
            "if": {
              "properties": {
                "status": { "const": "accepted-risk" }
              },
              "required": ["status"]
            },
            "then": {
              "required": ["owner", "expiry"]
            }
          }
        ],
        "properties": {
          "rule": { "type": "string", "minLength": 1 },
          "severity": { "type": "string", "enum": ["critical", "high", "medium", "low", "info"] },
          "file": { "type": "string", "minLength": 1 },
          "line": { "type": "integer", "minimum": 1 },
          "evidence": { "type": "string", "minLength": 1 },
          "remediation": { "type": "string", "minLength": 1 },
          "status": {
            "type": "string",
            "enum": ["open", "fixed", "accepted-risk"],
            "description": "Required remediation state for orchestration gates."
          },
          "category": {
            "type": "string",
            "enum": [
              "access-control",
              "xss",
              "csrf",
              "secrets",
              "security-headers",
              "cookies-session",
              "production-exposure",
              "dependencies",
              "ssrf",
              "file-upload",
              "injection",
              "path-traversal",
              "open-redirect",
              "jwt-auth"
            ],
            "description": "Security category tag (required in practice for security audits)."
          },
          "cwe": {
            "type": "string",
            "description": "Optional CWE reference (e.g. CWE-79)."
          },
          "owasp": {
            "type": "string",
            "description": "Optional OWASP reference (e.g. A01:2021)."
          },
          "owner": {
            "type": "string",
            "description": "Required for accepted-risk items."
          },
          "expiry": {
            "type": "string",
            "format": "date-time",
            "description": "Required for accepted-risk items."
          },
          "fix_ref": {
            "type": "string",
            "description": "Optional reference to commit/PR/patch where the fix was applied."
          }
        }
      }
    },
    "summary": {
      "type": "object",
      "additionalProperties": false,
      "required": ["pass", "warn", "fail", "open", "fixed", "accepted_risk"],
      "properties": {
        "pass": { "type": "integer", "minimum": 0 },
        "warn": { "type": "integer", "minimum": 0 },
        "fail": { "type": "integer", "minimum": 0 },
        "open": { "type": "integer", "minimum": 0 },
        "fixed": { "type": "integer", "minimum": 0 },
        "accepted_risk": { "type": "integer", "minimum": 0 }
      }
    },
    "security_audit": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "categories_covered",
        "checks",
        "fix_loop",
        "tools",
        "risk_signoff_required"
      ],
      "allOf": [
        {
          "if": {
            "properties": {
              "risk_signoff_required": { "const": true }
            },
            "required": ["risk_signoff_required"]
          },
          "then": {
            "required": ["risk_signoffs"],
            "properties": {
              "risk_signoffs": {
                "minItems": 1
              }
            }
          }
        }
      ],
      "properties": {
        "categories_covered": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "access-control",
              "xss",
              "csrf",
              "secrets",
              "security-headers",
              "cookies-session",
              "production-exposure",
              "dependencies",
              "ssrf",
              "file-upload",
              "injection",
              "path-traversal",
              "open-redirect",
              "jwt-auth"
            ]
          },
          "minItems": 14,
          "uniqueItems": true
        },
        "checks": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "access_control",
            "xss",
            "csrf",
            "secrets",
            "security_headers",
            "cookies_session",
            "production_exposure",
            "dependencies",
            "ssrf",
            "file_upload",
            "injection",
            "path_traversal",
            "open_redirect",
            "jwt_auth"
          ],
          "properties": {
            "access_control": { "const": true },
            "xss": { "const": true },
            "csrf": { "const": true },
            "secrets": { "const": true },
            "security_headers": { "const": true },
            "cookies_session": { "const": true },
            "production_exposure": { "const": true },
            "dependencies": { "const": true },
            "ssrf": { "const": true },
            "file_upload": { "const": true },
            "injection": { "const": true },
            "path_traversal": { "const": true },
            "open_redirect": { "const": true },
            "jwt_auth": { "const": true }
          }
        },
        "fix_loop": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "rounds",
            "critical_high_before",
            "critical_high_after",
            "rescan_completed"
          ],
          "properties": {
            "rounds": { "type": "integer", "minimum": 1 },
            "critical_high_before": { "type": "integer", "minimum": 0 },
            "critical_high_after": { "const": 0 },
            "rescan_completed": { "const": true }
          }
        },
        "tools": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "minItems": 1
        },
        "risk_signoff_required": { "type": "boolean" },
        "risk_signoffs": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["owner", "justification", "expiry", "follow_up"],
            "properties": {
              "owner": { "type": "string", "minLength": 1 },
              "justification": { "type": "string", "minLength": 1 },
              "expiry": { "type": "string", "format": "date-time" },
              "follow_up": { "type": "string", "minLength": 1 }
            }
          }
        }
      }
    }
  }
}
